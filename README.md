# SPMManifestTool

Utilities and templates for Swift Package Manager manifest files (Package.swift).

## Features

### EnvManager

A powerful environment variable manager designed for use in Swift Package Manager manifests, providing:

- **Domain-based variable lookup**: Automatically searches for domain-prefixed environment variables
- **Multiple value types**: Supports `Bool`, `Int`, and `String`
- **Debug output**: Prints environment variable resolution for better visibility during builds
- **Clean API**: Simplified environment variable usage with type-safe defaults
- **Temporary domains**: Use `withDomain()` for scoped environment variable lookups

## Installation

Copy the EnvManager implementation directly into your `Package.swift` file, or use the sync script to keep it updated.

### Option 1: Manual Copy

Copy the contents of `Templates/EnvManager.swift.template` into your `Package.swift` file.

### Option 2: Using Sync Script

Add markers to your `Package.swift`:

```swift
// swift-tools-version: 6.1

import Foundation
import PackageDescription

/* GENERATED BY SPMManifestTool. DO NOT EDIT */

/* END GENERATED BY SPMManifestTool */

// Rest of your Package.swift
```

Then run the sync script:

```bash
cd /path/to/SPMManifestTool
./Scripts/sync_env_manager.sh ../YourProject
```

## Usage

### Basic Setup

In your `Package.swift`, import and configure EnvManager:

```swift
// swift-tools-version: 6.1

import PackageDescription
import SPMManifestTool

// Register your project domains
EnvManager.shared.register(domain: "MyProject")
EnvManager.shared.register(domain: "OpenSwiftUI")
```

### Querying Environment Variables

#### Boolean Values

```swift
// Searches for: MYPROJECT_DEBUG, OPENSWIFTUI_DEBUG, DEBUG
let debug = envBoolValue("DEBUG", default: false)

// Disable domain search for system variables
let isSPI = envBoolValue("SPI_BUILD", default: false, searchInDomain: false)
```

Environment variable format:
- `"1"` → `true`
- `"0"` → `false`
- Any other value → falls back to default

#### Integer Values

```swift
// Searches for: MYPROJECT_TARGET_RELEASE, OPENSWIFTUI_TARGET_RELEASE, TARGET_RELEASE
let releaseVersion = envIntValue("TARGET_RELEASE", default: 2024)
```

#### String Values

```swift
// With default value
let toolchainPath = envStringValue("SWIFT_TOOLCHAIN_PATH", default: "/usr/local/swift")

// Optional (no default)
let customPath = envStringValue("CUSTOM_PATH")
// Returns nil if not found
```

### Domain Prefixing

When `searchInDomain: true` (the default), EnvManager searches for environment variables in this order:

1. `DOMAIN1_KEY`
2. `DOMAIN2_KEY`
3. `KEY`

For example, with domains `["MyProject", "OpenSwiftUI"]` and key `"DEBUG"`:

1. Checks `MYPROJECT_DEBUG`
2. Checks `OPENSWIFTUI_DEBUG`
3. Checks `DEBUG`
4. Falls back to default value

### Temporary Domains

Use `withDomain()` to temporarily add a domain for specific lookups:

```swift
let agVersion = EnvManager.shared.withDomain("DarwinPrivateFrameworks") {
    envIntValue("TARGET_RELEASE", default: 2024)
}
// This searches: DARWINPRIVATEFRAMEWORKS_TARGET_RELEASE, then other registered domains
```

### Complete Example

```swift
// swift-tools-version: 6.1

import Foundation
import PackageDescription
import SPMManifestTool

// Register project domains
EnvManager.shared.register(domain: "MyProject")
EnvManager.shared.register(domain: "OpenSwiftUI")

// Query environment variables
let development = envBoolValue("DEVELOPMENT", default: false)
let releaseVersion = envIntValue("TARGET_RELEASE", default: 2024)
let toolchainPath = envStringValue("SWIFT_TOOLCHAIN_PATH", default: "")

// Use them in your package configuration
var swiftSettings: [SwiftSetting] = [
    .swiftLanguageMode(.v5),
]

if development {
    swiftSettings.append(.unsafeFlags(["-warnings-as-errors"]))
}

let package = Package(
    name: "MyProject",
    products: [
        .library(name: "MyProject", targets: ["MyProject"]),
    ],
    targets: [
        .target(
            name: "MyProject",
            swiftSettings: swiftSettings
        ),
    ]
)
```

## Environment Variable Examples

### Setting Environment Variables

```bash
# Using domain prefix (recommended)
export MYPROJECT_DEBUG=1
export MYPROJECT_TARGET_RELEASE=2025

# Without prefix (will be found as fallback)
export DEBUG=1

# Build with environment variable
MYPROJECT_DEVELOPMENT=1 swift build
```

### Common Patterns

```swift
// Platform detection
#if os(macOS)
let buildForDarwin = envBoolValue("BUILD_FOR_DARWIN_PLATFORM", default: true)
#else
let buildForDarwin = envBoolValue("BUILD_FOR_DARWIN_PLATFORM")
#endif

// Library evolution
let libraryEvolution = envBoolValue("LIBRARY_EVOLUTION", default: buildForDarwin)
if libraryEvolution {
    sharedSwiftSettings.append(.unsafeFlags(["-enable-library-evolution"]))
}

// Development mode with Xcode detection
let isXcode = envStringValue("__CFBundleIdentifier", searchInDomain: false) == "com.apple.dt.Xcode"
let development = envBoolValue("DEVELOPMENT", default: false)
let werror = envBoolValue("WERROR", default: isXcode && development)
```

## Debug Output

EnvManager automatically prints debug information during package resolution:

```
[Env] MYPROJECT_DEBUG=1 -> true
[Env] MYPROJECT_TARGET_RELEASE not set -> 2024(default)
[Env] __CFBundleIdentifier=com.apple.dt.Xcode -> com.apple.dt.Xcode
```

This helps you understand which environment variables are being used and their values.

## Requirements

- Swift 6.1 or later
- macOS 10.15 or later (for Package.swift execution)

## License

MIT License

Copyright (c) 2025 OpenSwiftUIProject

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.
